generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  operador
  auditor
}

model Cliente {
  id        String   @id @default(cuid())
  nombre    String
  dni       String   @unique
  telefono  String?
  email     String?
  contratos Contrato[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Moto {
  id        String   @id @default(cuid())
  marca     String
  modelo    String
  patente   String   @unique
  anio      Int
  estado    String
  contratos Contrato[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contrato {
  id           String   @id @default(cuid())
  clienteId    String
  motoId       String
  fechaInicio  DateTime
  fechaFin     DateTime
  precioSemana Int
  estado       String

  cliente Cliente @relation(fields: [clienteId], references: [id])
  moto    Moto    @relation(fields: [motoId], references: [id])

  pagos    Pago[]
  alertas  Alerta[]
  facturas Factura[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pago {
  id            String   @id @default(cuid())
  contratoId    String
  monto         Int
  metodo        String
  estado        String
  referencia    String?
  pagadoAt      DateTime?
  vencimientoAt DateTime?

  contrato Contrato @relation(fields: [contratoId], references: [id])
  alertas  Alerta[]
  factura  Factura?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Factura {
  id           String   @id @default(cuid())
  contratoId   String
  pagoId       String   @unique
  numero       String
  monto        Int
  estado       String
  emitidaAt    DateTime

  // AFIP
  cae          String?
  caeVto       DateTime?
  afipEstado   String?

  // EMAIL
  emailEnviado Boolean  @default(false)
  emailAt      DateTime?

  contrato Contrato @relation(fields: [contratoId], references: [id])
  pago     Pago     @relation(fields: [pagoId], references: [id])

  createdAt DateTime @default(now())
}

model Alerta {
  id         String   @id @default(cuid())
  tipo       String
  mensaje    String

  contratoId String?
  pagoId     String?

  contrato Contrato? @relation(fields: [contratoId], references: [id])
  pago     Pago?     @relation(fields: [pagoId], references: [id])

  leida     Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Usuario {
  id           String   @id @default(cuid())
  email        String   @unique
  nombre       String
  role         Role     @default(operador)
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
