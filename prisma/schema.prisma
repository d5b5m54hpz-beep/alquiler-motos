generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  emailVerifiedAt  DateTime?
  name             String
  image            String?
  provider         String
  password         String?
  phone            String?
  phoneVerifiedAt  DateTime?
  role             String   @default("cliente") // admin | operador | cliente
  
  // Two-Factor Authentication
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?
  twoFactorBackupCodes String[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cliente          Cliente?
}

model Cliente {
  id        String   @id @default(cuid())
  userId    String   @unique
  nombre    String
  dni       String?  @unique
  telefono  String?
  email     String?
  contratos Contrato[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
}

model Moto {
  id        String   @id @default(cuid())
  marca     String
  modelo    String
  patente   String   @unique
  anio      Int
  estado    String
  contratos Contrato[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contrato {
  id           String   @id @default(cuid())
  clienteId    String
  motoId       String
  fechaInicio  DateTime
  fechaFin     DateTime
  precioSemana Int
  estado       String

  cliente Cliente @relation(fields: [clienteId], references: [id])
  moto    Moto    @relation(fields: [motoId], references: [id])

  pagos     Pago[]
  facturas  Factura[]
  alertas   Alerta[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pago {
  id            String   @id @default(cuid())
  contratoId    String
  monto         Int
  metodo        String
  estado        String
  referencia    String?
  pagadoAt      DateTime?
  vencimientoAt DateTime?

  contrato Contrato @relation(fields: [contratoId], references: [id])
  factura  Factura?
  alertas  Alerta[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Factura {
  id           String   @id @default(cuid())
  contratoId   String
  pagoId       String   @unique
  numero       String
  monto        Int
  estado       String
  emitidaAt   DateTime

  cae          String?
  caeVto       DateTime?
  afipEstado   String   @default("pendiente")

  emailEnviado Boolean  @default(false)
  emailAt      DateTime?

  contrato Contrato @relation(fields: [contratoId], references: [id])
  pago     Pago     @relation(fields: [pagoId], references: [id])

  createdAt DateTime @default(now())
}

model Alerta {
  id         String   @id @default(cuid())
  tipo       String
  mensaje    String

  contratoId String?
  pagoId     String?

  contrato   Contrato? @relation(fields: [contratoId], references: [id])
  pago       Pago?     @relation(fields: [pagoId], references: [id])

  leida      Boolean  @default(false)
  
  // Para verificaciones DNI
  dniVerificacion Json?
  
  createdAt DateTime @default(now())
}
